<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">微信双开还是微信定时炸弹？- 关于非越狱iOS上微信分身高危插件ImgNaix的分析</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">蒸米</a> <span class="bull">·</span> <time title="2016/04/28 11:01" ui-time="" datetime="2016/04/28 11:01" class="published ng-binding ng-isolate-scope">2016/04/28 11:01</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ae463c16491f1dee4736114729224909154b24064b00274b2b06">[email&#160;protected]</a></p><h1>0x00 序</h1><hr><p>微信作为手机上的第一大应用，有着上亿的用户。并且很多人都不只拥有一个微信帐号，有的微信账号是用于商业的，有的是用于私人的。可惜的是官方版的微信并不支持多开的功能，并且频繁更换微信账号也是一件非常麻烦的事，于是大家纷纷在寻找能够在手机上登陆多个微信账号的方法，相对于iOS，Android上早就有了很成熟的产品，比如360 OS的微信双开和LBE的双开大师就可以满足很多用户多开的需求。但是在iOS上，因为苹果的安全机制，并没有任何知名的IT厂商推出微信多开的产品，反而是各种小公司的微信双开产品满天飞。但使用这些产品真的安全吗？今天我们就来看看这些产品的真面目。</p><h1>0x01 ”倍推微信分身”初探</h1><hr><p>这次要分析的产品名字叫”倍推微信分身”，可以实现非越狱iOS上的微信多开。这个app的安装是通过itms-services，也就是企业证书的安装模式进行安装的。服务器是架在59os.com。可以看到除了微信分身以外，还有很多别的破解应用提供下载：</p><p><img height="500" width="368" img-src="e22f6c1d2b582d128ed4b09a505b8ba413aafa32.jpg"></p><p>app安装完后的图标和微信的一模一样，只是名字变成了“倍推微信分身”：</p><p><img alt="" img-src="7dae988c8964973108f019fd35ff1fdf926828b9.jpg"></p><p>下载完倍推微信分身，并登陆后，可以看到首页与原版微信并没有太大的变化，只是左上角多了一个VIP的标志：</p><p><img alt="" img-src="4dd57afd3843cd1a7f02b3152ad741efa34bb2d5.jpg"></p><p>我们知道，根据苹果的系统机制，一台iOS设备上不允许存在多个Bundle ID一样的app。因此，我们猜测这个微信分身app是修改过Bundle ID的。于是我们查看一下Info.plist，果然Bundle ID已经做了修改：</p><p><img alt="" img-src="1a2eeee32217845e2db741a79ecdb89e5342366d.jpg"></p><p>但是研究过iOS上微信分身的人一定知道，微信app在启动以及发送消息的时候会对Bundle ID做校验的，如果不是” com.tencent.xin”就会报错并退出。那么”倍推微信分身”是怎么做到的呢？经过分析，原来”倍推微信分身”是通过hook的手段，在app启动的时候对BundleID做了动态修改。至于怎么进行非越狱iOS上的hook可以参考我之前写的两篇文章：</p><p><a href="http://drops.wooyun.org/papers/12803">iOS冰与火之歌番外篇 - 在非越狱手机上进行App Hook</a></p><p><a href="http://drops.wooyun.org/papers/13824">iOS冰与火之歌番外篇 - App Hook答疑以及iOS 9砸壳</a></p><p>于是我们对”倍推微信分身”的binary进行分析，发现这个binary在启动的时候会load一个伪装成一个png文件的第三方的dylib – wanpu.png：</p><p><img alt="" img-src="e47c6a979aa19219db01fd7174e8e59b8a7852ec.jpg"></p><p>用file指令可以看到这个伪png文件其实是一个包含了armv7和arm64的dylib：</p><p><img alt="" img-src="83be8a72f347bdfe160cb56e860456ffe97e97f4.jpg"></p><p>我们看到这个伪图片就像是一个寄生虫一样存在于微信app的体内，特别像dota里的Naix（俗称小狗）的终极技能 - 寄生，因此我们把这个高危样本称之为ImgNaix。</p><p><img alt="" img-src="db0c2865ee87d549b823fc685d2f698f8000ba2b.jpg"></p><h1>0x02 wanpu.png分析</h1><hr><p>用ida打开wanpu.png，可以看到这个dylib分别对BundleID，openURL和NewMainFrameViewController进行了hook：</p><p><img alt="" img-src="dfa0ff45c471b1280669eb2cae500affe9cea147.jpg"></p><p>BundleID不用说，是为了让app在运行的时候改回”com.tencent.xin”。</p><p>NewMainFrameViewController的hook函数就是在微信主页上显示VIP的图片，以及传输一些非常隐私的用户数据（ssid, mac, imei等）到开发者自己的服务器上：</p><p><img alt="" img-src="dcbcda32fcf3b168a3b022fbfd9dd84b06ec1c47.jpg"></p><p><img alt="" img-src="1157c73edde3607d167c06504dad3e2f5ae5ea5b.jpg"></p><p>OpenURL这个hook就很有意思了，这个函数本身是用来处理调用微信的URL Schemes的。看过我之前写过的《iOS URL Scheme 劫持》的文章的人一定知道这个”倍推微信分身”是有能力进行URL Scheme劫持的，如果在Info.plist里进行了声明，手机上所有使用的URL Schemes的应用都有可能被hijack。</p><p>除了这些hook以外，我们在竟然在”倍推微信分身”的逆向代码里，发现了Alipay的SDK！一个没想到，在”倍推微信分身”的帮助下，支付宝和微信支付终于走到了一起：</p><p><img alt="" img-src="b0d8da99b82d1b0e0b1dda7c1b1fad903e3d7f01.jpg"></p><p>因为捆绑了支付宝的SDK，”倍推微信分身”可以调用支付宝的快捷支付功能：</p><p><img alt="" img-src="41ee3d6feb57081e98f09bc4f28a74eefef41f8f.jpg"></p><p>通过网络抓包分析，我们可以看到”倍推微信分身”会发送一些服务收费的数据到手机上：</p><p><img alt="" img-src="9958bd890efc89dab6c23ca9aaad06e8df457226.jpg"></p><p>经分析，”倍推微信分身”之所以加入支付宝sdk是为了对这个微信多开app进行收费。因为天下没有免费的午餐，软件开发者之所以制作腾讯的盗版软件”倍推微信分身”就是为了能够获取到一定的收入，所以才会接入支付SDK的。</p><h1>0x03 高危接口分析</h1><hr><p>需要注意的是，”倍推微信分身”打开的url数据都是服务端可控的，并且没有进行加密，黑客可以使用MITM (Man-in-the-middle attack) 随意修改推送的内容，进行钓鱼攻击等操作。比如我通过DNS劫持就能够随意修改推送给用户的数据，以及诱导用户去下载我自己设定的企业app，简直和XcodeGhost一模一样（具体细节可以参考我之前发表的<a href="http://drops.wooyun.org/papers/9024">《你以为服务器关了这事就结束了？ - XcodeGhost截胡攻击和服务端的复现，以及UnityGhost预警》</a>）。</p><p>这里我们进行DNS劫持并修改了推送的内容，同时我们把URL替换成了另一个企业应用的下载plist：</p><p><img alt="enter image description here" img-src="fc815a4acda481505f514ac9d4821c07a94db3ce.jpg"></p><p>可以看到我们在启动”倍推微信分身”的时候弹出了更新对话框,还无法取消:</p><p><img alt="enter image description here" height="667" width="375" img-src="21ade13a6c4b2b650ac79bfe5fca3aaa91d1abe6.jpg"></p><p>点击后,”倍推微信分身”下载了我们替换后的企业应用,一个伪装成微信的假 app:</p><p><img alt="enter image description here" height="500" width="280" img-src="f0706a6bcfbc56e9880b2b88a0f81f49c134ee69.jpg"></p><p>除此之外,在分析的过程中,我们还发现”倍推微信分身”app 还存在非常多的高危接口,并 且可以利用第三方服务器的控制进行远程调用:</p><p>(1). “倍推微信分身”app利用动态加载的方式调用了很多私有API。比如app使用了MobileCoreServices里的<code>[LSApplicationWorkspace allInstalledApplications]</code>来获取手机上安装的应用：</p><p><img alt="" img-src="e7ba3444d2eeb46216fe04582664e403a0842edb.jpg"></p><p><img alt="" img-src="c007a0b264744e388c295b810ea0a656c23c2b8a.jpg"></p><p><img alt="" img-src="117b874817ec44d546ba6708591564be5ffc416a.jpg"></p><p>比如app使用了SpringBoardServices的SBSLaunchApplicationWithIdentifier。这个API 可以在不需要url scheme的情况下调起目标app：</p><p><img alt="" img-src="33cd8fb3a5b55dc2bb94ecbab9ae2370edb57526.jpg"></p><p><img alt="" img-src="68d5d4a0e44b5bceecf0ce0d2b7946535d677ebe.jpg"></p><p>比如app加载了和应用安装有关的私有Framework MobileInstallation以及预留了通过URL Scheme安装企业app的接口：</p><p><img alt="" img-src="0822a1777a8229597b37082b720f2ccb09798315.jpg"></p><p><img alt="" img-src="540a4a9fa21b7de0961261bd368b9030747964c2.jpg"></p><p>(2). “倍推微信分身”app预留了一整套文件操作的高危接口，可以直接对微信app内的所有文件进行操作，这些文件包括好友列表，聊天记录，聊天图片等隐私信息。</p><p><img alt="" img-src="b6d2f626adbce9937abc60fc80d5b3d0a359f922.jpg"></p><p>要知道在iOS上，聊天记录等信息都是完全没有加密的保存在MM.sqlite文件里的：</p><p><img alt="" img-src="56205832ba0dbdbcb9169d244482fa085ce1400d.jpg"></p><h1>0x04 总结</h1><hr><p>虽然我们在样本分析的过程中除了获取用户隐私外，暂时没有捕获到恶意攻击的行为，但这个”倍推微信分身”预留了大量高危的接口（私有API，URL Scheme Hijack，文件操作接口等），并且破解者是可以随便修改客户端的内容，因此不要说推送任意广告和收费信息了，连窃取微信账号密码的可能性都有，简直就像一颗定时炸弹装在了手机上。这样的微信双开你还敢用吗？</p><p>从这个样本中，我们已经看到在非越狱iOS上的攻防技术已经变的非常成熟了， 无论是病毒（XcodeGhost）还是破解软件（ImgNaix）都利用了很多苹果安全机制的弱点，并且随着研究iOS安全的人越来越多，会有更多的漏洞会被发现 (e.g., 利用XPC漏洞过App沙盒 http://drops.wooyun.org/papers/14170)。此外，iOS上的app不像Android，简直一点防护措施都没有，当遇到黑客攻击的时候几乎会瞬间沦陷。正如同我在MDCC 2015开发者大会上所讲的，XcodeGhost只是一个开始而已，随后会有越来越多的危机会出现在iOS上，请大家做好暴风雨来临前的准备吧！</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div id="donate" style="padding:10px;border-top:1px solid #d9d9d9;text-align:center"><span>碎银子打赏，作者好攒钱娶媳妇：</span><br><br><img src="http://static.wooyun.org/wooyun/upload/donate/201507292354527496d304665a3c721617737c107e4e87.png" style="width:200px;height:200px"></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">K哥</span> <span class="reply-time">2016-06-01 18:03:42</span></div><p></p><p>现在下载不下来了，能提供一份样本吗?</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">信号旗</span> <span class="reply-time">2016-05-12 10:20:51</span></div><p></p><p>楼主，为什么我改了bundle id 就安装不成功了呢？望指教。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">colbert</span> <span class="reply-time">2016-05-06 10:16:11</span></div><p></p><p>没看太懂，到底是ImgNaixhook了原生微信，还是hook了倍推分身微信？<br>到底是仿冒了一个假的微信，还是真的是hook了微信客户端？</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Fox</span> <span class="reply-time">2016-04-29 08:11:45</span></div><p></p><p>整个微信都逆出来了，还外挂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">Fox</span> <span class="reply-time">2016-04-29 08:10:42</span></div><p></p><p>第三方软件都是外挂</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">隳易</span> <span class="reply-time">2016-04-28 14:45:33</span></div><p></p><p>幸好老子没有多开的需求。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zhuliang</span> <span class="reply-time">2016-04-28 12:52:56</span></div><p></p><p>请问能把wanpu.png样本给我共享一下吗？我现在下载不了样本了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zhuliang</span> <span class="reply-time">2016-04-28 12:50:53</span></div><p></p><p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9e78160f79041a771c3079302f780631f6ebfff0f9e4f6ebf2f7fff0f9def9f3fff7f2b0fdf1f3">[email&#160;protected]</a></p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">zhuliang</span> <span class="reply-time">2016-04-28 12:50:26</span></div><p></p><p>请问能把wanpu.png样本给我恭喜一下吗？我现在下载不了样本了。</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">sxyzbbs</span> <span class="reply-time">2016-04-28 12:22:01</span></div><p></p><p>好口怕～!!!</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">周鸿祎的爸爸</span> <span class="reply-time">2016-04-28 12:19:49</span></div><p></p><p>笑而不语</p><p></p></div></div></div></div></div></main>